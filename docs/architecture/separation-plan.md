# æœ¬åœ°ç”Ÿæ´»æœåŠ¡é¡¹ç›®æ¶æ„åˆ†ç¦»æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¶æ„ç°çŠ¶è¯„ä¼°

### ğŸ” å½“å‰æ¶æ„åˆ†æ

ä½œä¸ºèµ„æ·±æ¶æ„å¸ˆï¼ŒåŸºäºå¯¹é¡¹ç›®çš„å…¨é¢è¯„ä¼°ï¼Œå½“å‰æ¶æ„å­˜åœ¨ä»¥ä¸‹ç‰¹å¾å’Œé—®é¢˜ï¼š

#### é¡¹ç›®ç»“æ„ç°çŠ¶

```
local-life-service-app/
â”œâ”€â”€ backend/                    # Node.js + Express + MongoDB + Redis
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ user-app/              # uni-app ç”¨æˆ·ç«¯åº”ç”¨
â”‚   â””â”€â”€ merchant-app/          # uni-app å•†æˆ·ç«¯åº”ç”¨
â”œâ”€â”€ scripts/                   # ç»Ÿä¸€æ„å»ºéƒ¨ç½²è„šæœ¬
â”œâ”€â”€ docker/                    # åˆ†æ•£çš„Dockeré…ç½®
â”œâ”€â”€ docs/                      # å…±äº«æ–‡æ¡£
â””â”€â”€ package.json               # æ ¹ç›®å½•å…±äº«é…ç½®
```

#### æŠ€æœ¯æ ˆåˆ†æ

- **åç«¯æœåŠ¡**: Express.js + TypeScript + MongoDB + Redis + Socket.IO
- **ç”¨æˆ·ç«¯**: uni-app + Vue 3 + TypeScript + Vite
- **å•†æˆ·ç«¯**: uni-app + Vue 3 + TypeScript + Vite
- **éƒ¨ç½²**: Dockerå®¹å™¨åŒ– + Nginxåå‘ä»£ç†

#### å¤æ‚åº¦æŒ‡æ ‡

- **æ„å»ºè„šæœ¬**: 229è¡Œï¼ˆscripts/build.shï¼‰
- **éƒ¨ç½²è„šæœ¬**: 562è¡Œï¼ˆscripts/deploy.shï¼‰
- **æŠ€æœ¯æ–‡æ¡£**: 3222è¡Œæœ€ä½³å®è·µæ–‡æ¡£
- **å­é¡¹ç›®æ•°é‡**: 3ä¸ªç‹¬ç«‹åº”ç”¨

### ğŸš¨ æ¶æ„é—®é¢˜è¯†åˆ«

#### 1. æ„å»ºå¤æ‚æ€§è¿‡é«˜

- éœ€è¦åœ¨æ ¹ç›®å½•åè°ƒ3ä¸ªä¸åŒæŠ€æœ¯æ ˆçš„é¡¹ç›®
- ç»Ÿä¸€æ„å»ºè„šæœ¬ç»´æŠ¤æˆæœ¬é«˜
- æ„å»ºå¤±è´¥å½±å“æ‰€æœ‰é¡¹ç›®

#### 2. éƒ¨ç½²è€¦åˆä¸¥é‡

- 562è¡Œéƒ¨ç½²è„šæœ¬è¡¨æ˜å¤æ‚åº¦å·²è¶…å‡ºåˆç†èŒƒå›´
- ä»»ä¸€æ¨¡å—å˜æ›´éƒ½éœ€è¦æ•´ä½“é‡æ–°éƒ¨ç½²
- æ— æ³•å®ç°ç‹¬ç«‹çš„ç°åº¦å‘å¸ƒ

#### 3. ç‰ˆæœ¬ç®¡ç†å›°éš¾

- å‰åç«¯æ— æ³•ç‹¬ç«‹ç‰ˆæœ¬å‘å¸ƒ
- æ— æ³•é’ˆå¯¹å•ä¸€æ¨¡å—è¿›è¡Œçƒ­ä¿®å¤
- Gitå†å²æ··ä¹±ï¼Œå½±å“é—®é¢˜è¿½è¸ª

#### 4. å›¢é˜Ÿåä½œéšœç¢

- å‰åç«¯å¼€å‘å¿…é¡»åœ¨åŒä¸€ä»“åº“å·¥ä½œ
- ä»£ç å†²çªé£é™©å¢åŠ 
- æ— æ³•å®ç°ä¸“ä¸šåŒ–çš„CI/CDæµç¨‹

#### 5. è¿ç»´è´Ÿæ‹…è¿‡é‡

- å•ä¸€æ•…éšœç‚¹å½±å“æ‰€æœ‰æœåŠ¡
- èµ„æºæ— æ³•æŒ‰éœ€åˆ†é…
- ç›‘æ§å’Œæ—¥å¿—ç®¡ç†å¤æ‚

## ğŸ¯ åˆ†ç¦»æ–¹æ¡ˆå»ºè®®

### âœ… åˆ†ç¦»å¿…è¦æ€§ç»“è®º

**å¼ºçƒˆå»ºè®®è¿›è¡Œé¡¹ç›®åˆ†ç¦»**ï¼Œç†ç”±å¦‚ä¸‹ï¼š

1. **é¡¹ç›®è§„æ¨¡å·²è¾¾åˆ†ç¦»é˜ˆå€¼**: 3ä¸ªç‹¬ç«‹åº”ç”¨ï¼ŒæŠ€æœ¯æ ˆå·®å¼‚æ˜æ˜¾
2. **è¿ç»´å¤æ‚åº¦è¿‡é«˜**: éƒ¨ç½²è„šæœ¬è¶…è¿‡500è¡Œï¼Œç»´æŠ¤æˆæœ¬é«˜
3. **å›¢é˜Ÿåä½œæ•ˆç‡ä½**: å‰åç«¯å¼€å‘è€¦åˆï¼Œå½±å“å¹¶è¡Œå¼€å‘
4. **æŠ€æœ¯æ¼”è¿›å—é™**: æ— æ³•ç‹¬ç«‹å‡çº§å„æ¨¡å—æŠ€æœ¯æ ˆ

### ğŸ—ï¸ åˆ†ç¦»æ¶æ„è®¾è®¡

#### ç›®æ ‡æ¶æ„å›¾

```mermaid
graph TB
    subgraph "Backend Services"
        A[local-life-service-backend]
    end

    subgraph "Frontend Applications"
        B[local-life-service-user-app]
        C[local-life-service-merchant-app]
    end

    subgraph "Shared Resources"
        D[local-life-service-shared]
        E[API Documentation]
        F[Common Configs]
    end

    subgraph "Infrastructure"
        G[MongoDB]
        H[Redis]
        I[Nginx Gateway]
    end

    B --> A
    C --> A
    A --> G
    A --> H
    I --> A
    I --> B
    I --> C

    D --> A
    D --> B
    D --> C
```

#### åˆ†ç¦»åŸåˆ™

1. **ä¸šåŠ¡åŸŸéš”ç¦»**: æŒ‰ä¸šåŠ¡åŠŸèƒ½åˆ†ç¦»æœåŠ¡
2. **æŠ€æœ¯æ ˆç‹¬ç«‹**: æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹é€‰æ‹©æŠ€æœ¯æ ˆ
3. **æ•°æ®éš”ç¦»**: APIå¥‘çº¦æ˜ç¡®ï¼Œæ•°æ®è®¿é—®è§„èŒƒ
4. **éƒ¨ç½²ç‹¬ç«‹**: ç‹¬ç«‹çš„CI/CDæµç¨‹

## ğŸ“‹ è¯¦ç»†å®æ–½æ–¹æ¡ˆ

### ğŸš€ é˜¶æ®µ1: ä»“åº“æ‹†åˆ†ï¼ˆç¬¬1-2å‘¨ï¼‰

#### æ­¥éª¤1.1: åˆ›å»ºç‹¬ç«‹ä»“åº“

```bash
# Agentæ‰§è¡Œæ­¥éª¤
mkdir -p ../separated-repos
cd ../separated-repos

# åˆ›å»ºåç«¯ä»“åº“
git clone --bare ../local-life-service-app local-life-service-backend.git
git clone local-life-service-backend.git local-life-service-backend
cd local-life-service-backend

# åªä¿ç•™backendç›¸å…³æ–‡ä»¶
git filter-branch --prune-empty --subdirectory-filter backend HEAD
git remote remove origin
git remote add origin git@github.com:your-org/local-life-service-backend.git

# æ¸…ç†å†å²
git gc --aggressive --prune=now
cd ..

# ç±»ä¼¼æ–¹å¼åˆ›å»ºå‰ç«¯ä»“åº“
git clone --bare ../local-life-service-app local-life-service-user-app.git
git clone local-life-service-user-app.git local-life-service-user-app
cd local-life-service-user-app
git filter-branch --prune-empty --subdirectory-filter frontend/user-app HEAD
# ... ç±»ä¼¼æ“ä½œ
```

#### æ­¥éª¤1.2: åˆ›å»ºå…±äº«é…ç½®ä»“åº“

```bash
# åˆ›å»ºsharedä»“åº“
mkdir local-life-service-shared
cd local-life-service-shared
git init

# æ‹·è´å…±äº«é…ç½®
cp ../local-life-service-app/.prettierrc .
cp ../local-life-service-app/commitlint.config.cjs .
cp ../local-life-service-app/.gitignore .

# åˆ›å»ºå…±äº«å·¥å…·
mkdir -p packages/shared-utils
mkdir -p packages/api-types
mkdir -p config/environments
```

#### æ­¥éª¤1.3: æ›´æ–°package.jsoné…ç½®

```json
// local-life-service-backend/package.json
{
  "name": "local-life-service-backend",
  "version": "1.0.0",
  "repository": {
    "type": "git",
    "url": "git@github.com:your-org/local-life-service-backend.git"
  },
  "scripts": {
    "start": "node dist/index.js",
    "dev": "ts-node-dev --respawn --transpile-only src/index.ts",
    "build": "tsc",
    "test": "jest",
    "deploy:staging": "npm run build && ./scripts/deploy.sh staging",
    "deploy:production": "npm run build && ./scripts/deploy.sh production"
  }
}
```

### ğŸ”§ é˜¶æ®µ2: ç‹¬ç«‹CI/CDè®¾ç½®ï¼ˆç¬¬3-4å‘¨ï¼‰

#### æ­¥éª¤2.1: åç«¯CI/CDé…ç½®

```yaml
# .github/workflows/backend-ci.yml
name: Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to production
        run: npm run deploy:production
```

#### æ­¥éª¤2.2: å‰ç«¯CI/CDé…ç½®

```yaml
# .github/workflows/user-app-ci.yml
name: User App CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [h5, mp-weixin]

    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for ${{ matrix.platform }}
        run: npm run build:${{ matrix.platform }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.platform }}-dist
          path: dist/
```

#### æ­¥éª¤2.3: APIå¥‘çº¦ç®¡ç†

```bash
# åœ¨sharedä»“åº“ä¸­è®¾ç½®APIå¥‘çº¦
mkdir -p packages/api-contracts
cd packages/api-contracts

# ä½¿ç”¨OpenAPIå®šä¹‰APIå¥‘çº¦
cat > api-spec.yaml << 'EOF'
openapi: 3.0.0
info:
  title: Local Life Service API
  version: 1.0.0
paths:
  /api/stores/nearby/search:
    get:
      parameters:
        - name: latitude
          in: query
          required: true
          schema:
            type: number
        - name: longitude
          in: query
          required: true
          schema:
            type: number
        - name: radius
          in: query
          schema:
            type: number
            minimum: 0.1
            maximum: 50
            default: 5
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
EOF

# ç”ŸæˆTypeScriptç±»å‹å®šä¹‰
npx openapi-typescript api-spec.yaml --output types.ts
```

### ğŸ”„ é˜¶æ®µ3: æ¸è¿›å¼è¿ç§»ï¼ˆç¬¬5-6å‘¨ï¼‰

#### æ­¥éª¤3.1: APIç½‘å…³è®¾ç½®

```javascript
// api-gateway/server.js
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');

const app = express();

// åç«¯APIä»£ç†
app.use(
  '/api',
  createProxyMiddleware({
    target: process.env.BACKEND_URL || 'http://localhost:3000',
    changeOrigin: true,
    pathRewrite: {
      '^/api': '/api',
    },
  })
);

// é™æ€æ–‡ä»¶æœåŠ¡
app.use('/user-app', express.static('../user-app/dist'));
app.use('/merchant-app', express.static('../merchant-app/dist'));

app.listen(8080, () => {
  console.log('API Gateway running on port 8080');
});
```

#### æ­¥éª¤3.2: ç¯å¢ƒé…ç½®æ ‡å‡†åŒ–

```bash
# ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç¯å¢ƒé…ç½®
# backend/.env.example
DATABASE_URL=mongodb://localhost:27017/local-life-service
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-jwt-secret
API_PORT=3000

# user-app/.env.example
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_ENV=development

# merchant-app/.env.example
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_ENV=development
```

### ğŸ“¦ é˜¶æ®µ4: éƒ¨ç½²ä¼˜åŒ–ï¼ˆç¬¬7-8å‘¨ï¼‰

#### æ­¥éª¤4.1: DockeråŒ–æ”¹è¿›

```dockerfile
# backend/Dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY dist ./dist
COPY scripts ./scripts

EXPOSE 3000
CMD ["npm", "start"]
```

```dockerfile
# user-app/Dockerfile
FROM nginx:alpine

COPY dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### æ­¥éª¤4.2: å®¹å™¨ç¼–æ’ä¼˜åŒ–

```yaml
# docker-compose.yml
version: '3.8'
services:
  backend:
    build: ./backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - mongodb
      - redis

  user-app:
    build: ./user-app
    ports:
      - '8081:80'

  merchant-app:
    build: ./merchant-app
    ports:
      - '8082:80'

  api-gateway:
    build: ./api-gateway
    ports:
      - '8080:8080'
    depends_on:
      - backend
      - user-app
      - merchant-app
```

## ğŸ¯ Agentå‹å¥½çš„æ‰§è¡Œè®¡åˆ’

### è‡ªåŠ¨åŒ–è„šæœ¬åˆ›å»º

```bash
#!/bin/bash
# scripts/separate-repositories.sh

set -e

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# æ­¥éª¤1: ä»“åº“æ‹†åˆ†
separate_backend() {
    log "å¼€å§‹åˆ†ç¦»åç«¯ä»“åº“..."

    # éªŒè¯å‰ç½®æ¡ä»¶
    if [ ! -d "backend" ]; then
        log "é”™è¯¯: backendç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi

    # åˆ›å»ºåˆ†ç¦»ç›®å½•
    mkdir -p ../separated-repos
    cd ../separated-repos

    # å…‹éš†å¹¶è¿‡æ»¤åç«¯ä»£ç 
    git clone --bare ../local-life-service-app local-life-service-backend.git
    git clone local-life-service-backend.git local-life-service-backend

    cd local-life-service-backend
    git filter-branch --prune-empty --subdirectory-filter backend HEAD

    # éªŒè¯åˆ†ç¦»ç»“æœ
    if [ -f "package.json" ] && [ -d "src" ]; then
        log "âœ… åç«¯ä»“åº“åˆ†ç¦»æˆåŠŸ"
    else
        log "âŒ åç«¯ä»“åº“åˆ†ç¦»å¤±è´¥"
        exit 1
    fi

    cd ..
}

# æ‰§è¡Œåˆ†ç¦»æµç¨‹
main() {
    log "å¼€å§‹é¡¹ç›®åˆ†ç¦»æµç¨‹..."

    # ä¿å­˜å½“å‰å·¥ä½œç›®å½•
    ORIGINAL_DIR=$(pwd)

    # æ‰§è¡Œåˆ†ç¦»æ­¥éª¤
    separate_backend
    separate_user_app
    separate_merchant_app
    create_shared_repo

    # è¿”å›åŸç›®å½•
    cd "$ORIGINAL_DIR"

    log "âœ… é¡¹ç›®åˆ†ç¦»å®Œæˆï¼"
    log "æ–°ä»“åº“ä½ç½®: ../separated-repos/"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# scripts/verify-separation.sh

verify_repository() {
    local repo_name=$1
    local expected_files=("${@:2}")

    echo "éªŒè¯ä»“åº“: $repo_name"

    if [ ! -d "$repo_name" ]; then
        echo "âŒ ä»“åº“ç›®å½•ä¸å­˜åœ¨: $repo_name"
        return 1
    fi

    cd "$repo_name"

    # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
    for file in "${expected_files[@]}"; do
        if [ ! -e "$file" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
            return 1
        fi
    done

    # æ£€æŸ¥GitçŠ¶æ€
    if ! git status &>/dev/null; then
        echo "âŒ ä¸æ˜¯æœ‰æ•ˆçš„Gitä»“åº“"
        return 1
    fi

    # æ£€æŸ¥æ„å»º
    if [ -f "package.json" ]; then
        if npm install && npm run build; then
            echo "âœ… æ„å»ºæˆåŠŸ"
        else
            echo "âŒ æ„å»ºå¤±è´¥"
            return 1
        fi
    fi

    cd ..
    echo "âœ… $repo_name éªŒè¯é€šè¿‡"
}

# éªŒè¯æ‰€æœ‰ä»“åº“
cd ../separated-repos

verify_repository "local-life-service-backend" "package.json" "src/index.ts" "tsconfig.json"
verify_repository "local-life-service-user-app" "package.json" "src/main.ts" "vite.config.ts"
verify_repository "local-life-service-merchant-app" "package.json" "src/main.ts" "vite.config.ts"
verify_repository "local-life-service-shared" "package.json" "packages/"

echo "ğŸ‰ æ‰€æœ‰ä»“åº“éªŒè¯å®Œæˆï¼"
```

## ğŸ“Š é£é™©è¯„ä¼°ä¸ç¼“è§£

### ä¸»è¦é£é™©

1. **æ•°æ®ä¸€è‡´æ€§é£é™©**
   - é£é™©: APIè°ƒç”¨å¼‚å¸¸å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
   - ç¼“è§£: å®æ–½APIå¥‘çº¦æµ‹è¯•ï¼Œå»ºç«‹å›æ»šæœºåˆ¶

2. **æœåŠ¡ä¾èµ–é£é™©**
   - é£é™©: æœåŠ¡é—´è°ƒç”¨å¤±è´¥
   - ç¼“è§£: å®æ–½ç†”æ–­æœºåˆ¶ï¼Œå¥åº·æ£€æŸ¥

3. **éƒ¨ç½²å¤æ‚æ€§é£é™©**
   - é£é™©: å¤šä»“åº“éƒ¨ç½²åè°ƒå›°éš¾
   - ç¼“è§£: è‡ªåŠ¨åŒ–CI/CDï¼Œç‰ˆæœ¬æ ‡ç­¾ç®¡ç†

### å›æ»šç­–ç•¥

```bash
#!/bin/bash
# scripts/rollback.sh

rollback_to_monorepo() {
    log "å¼€å§‹å›æ»šåˆ°åŸå§‹monorepoç»“æ„..."

    # å¤‡ä»½åˆ†ç¦»çš„ä»“åº“
    cp -r ../separated-repos ../separated-repos-backup

    # æ¢å¤åŸå§‹ä»“åº“
    git checkout main
    git pull origin main

    log "âœ… å·²å›æ»šåˆ°åŸå§‹æ¶æ„"
}
```

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### çŸ­æœŸæ•ˆæœï¼ˆ1-2ä¸ªæœˆï¼‰

- âœ… æ„å»ºæ—¶é—´å‡å°‘50%
- âœ… éƒ¨ç½²å¤±è´¥ç‡é™ä½70%
- âœ… å›¢é˜Ÿå¼€å‘æ•ˆç‡æå‡30%

### ä¸­æœŸæ•ˆæœï¼ˆ3-6ä¸ªæœˆï¼‰

- âœ… ç‹¬ç«‹æŠ€æœ¯æ ˆå‡çº§èƒ½åŠ›
- âœ… ç²¾ç»†åŒ–æ€§èƒ½ä¼˜åŒ–
- âœ… ä¸“ä¸šåŒ–è¿ç»´ç›‘æ§

### é•¿æœŸæ•ˆæœï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰

- âœ… å¾®æœåŠ¡æ¶æ„åŸºç¡€
- âœ… å¤šå›¢é˜Ÿå¹¶è¡Œå¼€å‘
- âœ… äº‘åŸç”Ÿéƒ¨ç½²èƒ½åŠ›

## ğŸš€ ç«‹å³æ‰§è¡Œå»ºè®®

å»ºè®®æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§ç«‹å³å¼€å§‹ï¼š

1. **ç¬¬ä¸€ä¼˜å…ˆ**: æ‰§è¡Œä»“åº“åˆ†ç¦»è„šæœ¬
2. **ç¬¬äºŒä¼˜å…ˆ**: è®¾ç½®ç‹¬ç«‹CI/CD
3. **ç¬¬ä¸‰ä¼˜å…ˆ**: å»ºç«‹APIå¥‘çº¦ç®¡ç†
4. **ç¬¬å››ä¼˜å…ˆ**: ä¼˜åŒ–éƒ¨ç½²æµç¨‹

æ¯ä¸ªé˜¶æ®µéƒ½åŒ…å«è¯¦ç»†çš„éªŒè¯æ­¥éª¤ï¼Œç¡®ä¿Agentå¯ä»¥ç²¾ç¡®æ‰§è¡Œå’ŒéªŒè¯ç»“æœã€‚

---

_æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2025-09-18_  
_è´Ÿè´£æ¶æ„å¸ˆ: Senior Solution Architect_  
_é¢„è®¡å®æ–½å‘¨æœŸ: 8å‘¨_  
_é£é™©ç­‰çº§: ä¸­ç­‰ï¼ˆå¯æ§ï¼‰_
